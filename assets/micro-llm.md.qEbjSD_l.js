import{_ as i,c as s,o as a,M as t}from"./chunks/framework.Dt16nE2a.js";const h="/assets/simple-multiply.Bjy3ktAa.png",n="/assets/matrix-multiply.BzfPaAF2.png",k="/assets/Screenshot%202024-09-08%20at%201.16.39%20PM.DNhkExB2.png",l="/assets/Signal%20Note%20to%20Self%20-%202024-09-05%2008_15_12.Dko9Mq5f.jpeg",F=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"micro-llm.md","filePath":"micro-llm.md"}'),p={name:"micro-llm.md"},e=t(`<div class="tip custom-block"><p class="custom-block-title">This article is a work in progress</p></div><p>I took a weekend and tried to get an LLM running on an 8bit microcontroller- the ATmega328p in particular. This was of course an exercise in futility that turned into a simpler ambition of getting matrix multiplication working on the chip But I wanted to take this as far as possible so I could understand, at a fundamental level, what the minimum resources are to run one of these models.</p><blockquote><p>“What I cannot build, I do not understand” -Feynman</p></blockquote><h2 id="part-1-setting-up-a-math-validation-tool" tabindex="-1">Part 1: Setting up a math validation tool <a class="header-anchor" href="#part-1-setting-up-a-math-validation-tool" aria-label="Permalink to &quot;Part 1: Setting up a math validation tool&quot;">​</a></h2><p>I wanted to start simple to see what math I could feasibly do on the chip; that meant multiplying just two numbers. The easiest way to do this was to input numbers to a computer, send to the chip for calculation, get the result back, and validate it against an actual math library. I did this through a basic python client, and serial communication.</p><p>Python client:</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes catppuccin-macchiato night-owl vp-code"><code><span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">import</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> serial</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">import</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> time</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">def</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> send_numbers</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">(</span><span style="--shiki-light:#EE99A0;--shiki-dark:#7FDBCA;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">,</span><span style="--shiki-light:#EE99A0;--shiki-dark:#7FDBCA;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> a</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">,</span><span style="--shiki-light:#EE99A0;--shiki-dark:#7FDBCA;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> b</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">:</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">    ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">write</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">bytes</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">[</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">a </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">+</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 128</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> b </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">+</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 128</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">]</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">def</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> receive_result</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">(</span><span style="--shiki-light:#EE99A0;--shiki-dark:#7FDBCA;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">:</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    return</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> int</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">readline</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">()</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">decode</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">()</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">strip</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">())</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">ser </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> serial</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">Serial</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">/dev/tty.usbmodem2101</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 9600</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D7DBE0;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> timeout</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;">1</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">time</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">sleep</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;">2</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Connected to Arduino. Ready...</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">while</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#FF5874;"> True</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">:</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    try</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">:</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">        a </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> int</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">input</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Enter first number (-128 to 127): </span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">        b </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> int</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">input</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Enter second number (-128 to 127): </span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">        print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#C792EA;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">f</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">&quot;</span><span style="--shiki-light:#F5BDE6;--shiki-dark:#F78C6C;">\\n</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Multiplying </span><span style="--shiki-light:#F5BDE6;--shiki-dark:#82AAFF;">{</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">a</span><span style="--shiki-light:#F5BDE6;--shiki-dark:#82AAFF;">}</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;"> and </span><span style="--shiki-light:#F5BDE6;--shiki-dark:#82AAFF;">{</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">b</span><span style="--shiki-light:#F5BDE6;--shiki-dark:#82AAFF;">}</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">        send_numbers</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> a</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> b</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">        arduino_result </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;"> receive_result</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">        expected_result </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> a </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">*</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> b</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">        print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#C792EA;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">f</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">&quot;Arduino result: </span><span style="--shiki-light:#F5BDE6;--shiki-dark:#82AAFF;">{</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">arduino_result</span><span style="--shiki-light:#F5BDE6;--shiki-dark:#82AAFF;">}</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">        print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#C792EA;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">f</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">&quot;Expected result: </span><span style="--shiki-light:#F5BDE6;--shiki-dark:#82AAFF;">{</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">expected_result</span><span style="--shiki-light:#F5BDE6;--shiki-dark:#82AAFF;">}</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">        if</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> arduino_result </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">==</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> expected_result</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">:</span></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">            print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Result passed.</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">        else</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">:</span></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">            print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Result failed.</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">close</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">()</span></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Connection closed.</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span></code></pre></div><p>ATmega program:</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes catppuccin-macchiato night-owl vp-code"><code><span class="line"><span style="--shiki-light:#EED49F;--shiki-dark:#C792EA;">#</span><span style="--shiki-light:#EED49F;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">include</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;"> &lt;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">stdint.h</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#EED49F;--shiki-dark:#C792EA;">#</span><span style="--shiki-light:#EED49F;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">define</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> BAUD</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 9600</span></span>
<span class="line"><span style="--shiki-light:#EED49F;--shiki-dark:#C792EA;">#</span><span style="--shiki-light:#EED49F;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">define</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> F_CPU</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 16000000</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#FFEB95;">UL</span></span>
<span class="line"><span style="--shiki-light:#EED49F;--shiki-dark:#C792EA;">#</span><span style="--shiki-light:#EED49F;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">define</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> UBRR_VALUE</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> ((</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">F_CPU </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;">/</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">BAUD </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;">*</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 16</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#FFEB95;">UL</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">))</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;"> -</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 1</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6E738D;--shiki-dark:#637777;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">//</span><span style="--shiki-light:#6E738D;--shiki-dark:#637777;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">serial communication setup</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">void</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> uart_init</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">()</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> {</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">  UBRR0H </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">uint8_t</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">UBRR_VALUE </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">&gt;&gt;</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 8</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">);</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">  UBRR0L </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">uint8_t</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">UBRR_VALUE</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">  UCSR0B </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;">1</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;"> &lt;&lt;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> RXEN0</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;"> |</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;">1</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;"> &lt;&lt;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> TXEN0</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">);</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">  UCSR0C </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;">3</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;"> &lt;&lt;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> UCSZ00</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">);</span></span>
<span class="line"><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">void</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> uart_transmit</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">uint8_t</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D7DBE0;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> data</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> {</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  while</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">!</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">UCSR0A </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;">&amp;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;">1</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;"> &lt;&lt;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> UDRE0</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)))</span></span>
<span class="line"><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">    ;</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">  UDR0 </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> data</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span></span>
<span class="line"><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">uint8_t</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> uart_receive</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">()</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> {</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  while</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">!</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">UCSR0A </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;">&amp;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;">1</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;"> &lt;&lt;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> RXC0</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)))</span></span>
<span class="line"><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">    ;</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  return</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> UDR0</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span></span>
<span class="line"><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">void</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> uart_print_number</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">int16_t</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D7DBE0;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> num</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> {</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">  char</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#C5E478;"> buffer</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">[</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;">7</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">];</span></span>
<span class="line"><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  itoa</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">num</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> buffer</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 10</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  for</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">char</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;"> *</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">p </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> buffer</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;"> *</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">p</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> p</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">++</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> {</span></span>
<span class="line"><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    uart_transmit</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">(</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;">*</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">p</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span></span>
<span class="line"><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">  }</span></span>
<span class="line"><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  uart_transmit</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&#39;</span><span style="--shiki-light:#F5BDE6;--shiki-dark:#F78C6C;">\\n</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&#39;</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> </span></span>
<span class="line"><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">int</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> main</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">void</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> {</span></span>
<span class="line"><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  uart_init</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">()</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  while</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;">1</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> {</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">    int8_t</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> A </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">int8_t</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">uart_receive</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">()</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;"> -</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 128</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">    int8_t</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> B </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">int8_t</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">uart_receive</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">()</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;"> -</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 128</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">    int16_t</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> C </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">int16_t</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">A </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;">*</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> B</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    uart_print_number</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">C</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span></span>
<span class="line"><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  return</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 0</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span></span>
<span class="line"><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">}</span></span></code></pre></div><p>I setup everything under the assumption that I would eventually be using an 8bit quantized model. This enables me to work primarily with signed integers (ranging from -128 to 127), instead of floating point numbers. I used the int8 data type and shifted values to be between -128 and 127. Outputs can overflow into the 16bit range. <img src="`+h+`" alt="simple-multiply.png"> Once this was working, and the validation tests were passing, I felt comfortable expanding this to matrix multiplication.</p><h2 id="part-2-matrix-multiplication" tabindex="-1">Part 2: Matrix Multiplication <a class="header-anchor" href="#part-2-matrix-multiplication" aria-label="Permalink to &quot;Part 2: Matrix Multiplication&quot;">​</a></h2><p>If I could multiply two numbers, I felt it would be pretty straightforward to extend it to a matrix. I started with 2D matrices. For the sake of simplicity, I flattened 2D matrices into 1D arrays. This enabled memory to be easily allocated and accessed in contiguous blocks. Indexing into a value can be done with with: <code>matrix[i * size + k]</code> Where <code>i</code> is the row index, <code>size</code> is the column dimension, and <code>k</code> is the column index</p><p>For the matrix multiplication &quot;kernel&#39;&quot;, I used a brute force loop approach, borrowed from <a href="https://forum.arduino.cc/t/arduino-matrix-math-library/38123" target="_blank" rel="noreferrer">here</a>.</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes catppuccin-macchiato night-owl vp-code"><code><span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">void</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> matmult</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">int8_t</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;"> *</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D7DBE0;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">A</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">,</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;"> int8_t</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;"> *</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D7DBE0;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">B</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">,</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;"> int16_t</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;"> *</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D7DBE0;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">C</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">,</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;"> uint8_t</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D7DBE0;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> rows_A</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">,</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">                     uint8_t</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D7DBE0;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> cols_A</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">,</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;"> uint8_t</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D7DBE0;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> cols_B</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> {</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  for</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">uint8_t</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> i </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 0</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> i </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">&lt;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> rows_A</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> i</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">++</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> {</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    for</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">uint8_t</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> j </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 0</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> j </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">&lt;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> cols_B</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> j</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">++</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> {</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">      int32_t</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> sum </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 0</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">      for</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">uint8_t</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> k </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 0</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> k </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">&lt;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> cols_A</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> k</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">++</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> {</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">        sum </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">+=</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">int32_t</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#C5E478;">A</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">[</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">i </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;">*</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> cols_A </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;">+</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> k</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">]</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;"> *</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#C5E478;"> B</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">[</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">k </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;">*</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> cols_B </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;">+</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> j</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">];</span></span>
<span class="line"><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">      }</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#C5E478;">      C</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">[</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">i </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;">*</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> cols_B </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;">+</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> j</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">]</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;"> =</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">int16_t</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">sum</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span></span>
<span class="line"><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">    }</span></span>
<span class="line"><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">  }</span></span>
<span class="line"><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">}</span></span></code></pre></div><p>Because the values are stored inside of 1D arrays the dimensions of the matrices need to be explicitly passed in. I generated matrices with numpy, and used <code>np.array_equal()</code> to validate the results returned by the chip. Python client:</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes catppuccin-macchiato night-owl vp-code"><code><span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">import</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> time</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">import</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> numpy </span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">as</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> np</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">import</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> serial</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">def</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> send_matrix</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">(</span><span style="--shiki-light:#EE99A0;--shiki-dark:#7FDBCA;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">,</span><span style="--shiki-light:#EE99A0;--shiki-dark:#7FDBCA;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> matrix</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">:</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    for</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> value </span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">in</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> matrix</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">flatten</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">():</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">        ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">write</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">bytes</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">[</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">value </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">+</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 128</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">]</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">))</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">def</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> receive_matrix</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">(</span><span style="--shiki-light:#EE99A0;--shiki-dark:#7FDBCA;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">,</span><span style="--shiki-light:#EE99A0;--shiki-dark:#7FDBCA;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> rows</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">,</span><span style="--shiki-light:#EE99A0;--shiki-dark:#7FDBCA;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> cols</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">:</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">    matrix </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> np</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">zeros</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">rows</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> cols</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D7DBE0;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> dtype</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">np</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">.</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">int16</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    for</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> i </span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">in</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> range</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">rows</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">):</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">        for</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> j </span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">in</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> range</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">cols</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">):</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">            value_str </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">readline</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">().</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">decode</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">().</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">strip</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">()</span></span>
<span class="line"><span style="--shiki-light:#EE99A0;--shiki-dark:#D6DEEB;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">            matrix</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">[</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D6DEEB;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">i</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">,</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D6DEEB;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> j</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">]</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;"> =</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> int</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">value_str</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    return</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> matrix</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">ser </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> serial</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">Serial</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">/dev/tty.usbmodem2101</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 9600</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D7DBE0;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> timeout</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;">5</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">time</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">sleep</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;">2</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Connected...</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">while</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#FF5874;"> True</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">:</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">    rows_A </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> int</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">input</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">A matrix rows (1-16, or 0 to quit): </span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">))</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">    cols_A </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> int</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">input</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">A matrix columns (1-16): </span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">))</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">    cols_B </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> int</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">input</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">B matrix columns (1-16): </span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">    A </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> np</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">random</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">randint</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">-</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;">128</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 127</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;"> (</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">rows_A</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> cols_A</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D7DBE0;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> dtype</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">np</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">.</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">int8</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">    B </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> np</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">random</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">randint</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">-</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;">128</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 127</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;"> (</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">cols_A</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> cols_B</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D7DBE0;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> dtype</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">np</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">.</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">int8</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">    print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Matrix A:</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">    print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">A</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">    print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Matrix B:</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">    print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">B</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6E738D;--shiki-dark:#637777;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">    #</span><span style="--shiki-light:#6E738D;--shiki-dark:#637777;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> Send size and matrices</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">    ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">write</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">bytes</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">[</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">rows_A</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">]</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">))</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">    ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">write</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">bytes</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">[</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">cols_A</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">]</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">))</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">    ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">write</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">bytes</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">[</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">cols_B</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">]</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">))</span></span>
<span class="line"><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">    send_matrix</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> A</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">    send_matrix</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> B</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">    C </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;"> receive_matrix</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> rows_A</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> cols_B</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">    print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Result Matrix C:</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">    print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">C</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">    expected </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> np</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">matmul</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">A</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">astype</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">np</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">.</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">int32</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> B</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">astype</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">np</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">.</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">int32</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)).</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">astype</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">np</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">.</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">int16</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">    print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#C792EA;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">f</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">&quot;Expected Matrix C: </span><span style="--shiki-light:#F5BDE6;--shiki-dark:#82AAFF;">{</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">expected</span><span style="--shiki-light:#F5BDE6;--shiki-dark:#82AAFF;">}</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    if</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> np</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">array_equal</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">C</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> expected</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">):</span></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">        print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Result passed.</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    else</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">:</span></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">        print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Result failed</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">        print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Expected:</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">        print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">expected</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">        print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Difference:</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">        print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">C </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">-</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> expected</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">close</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">()</span></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Connection closed.</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span></code></pre></div><p>It took several hours of debugging to get this working; the math was wrong every time.</p><p>I really handicapped myself by writing my serial communication from scratch; It was a pain figuring out if my problems were math, memory management or data transfer related (turns out it was the latter..)</p><p>After several iterations of deleting and restarting from my basic multiplication example, I finally got my tests to pass on square matrices, and then finally matrices of varying dimensions. <img src="`+n+'" alt=""> This is where I ran into my first concrete roadblock; the one that I understood most easily from the beginning: The atmega328p has 2kB of RAM/ volatile memory.</p><p>This means it can hold a theoretical maximum of 2048 int8 values, or about one 45x45 int8 matrix. Mat-Mult requires allocation for 3 matrices, the third being int16 or int32 (because mat-mult of large int8 matrices could result in numbers higher than 32,768), so the maximum allowable dimension for each matrix is quite small.</p><p>My goal from the beginning was never to run this <em>entirely</em> on the ATmega, but to offload memory onto pseudo ram, ie repurposed solid state storage like an SD card. In my naive outlook, there isn&#39;t anything <em>fundamentally</em> different about volatile memory and solid state memory, they&#39;re both just storing bits somewhere 🤷 Sure there are many differences in speed and how data is accessed, but I felt I could at least implement a toy example for my own curiosity.</p><h2 id="part-3-memory-offloading" tabindex="-1">Part 3: Memory Offloading <a class="header-anchor" href="#part-3-memory-offloading" aria-label="Permalink to &quot;Part 3: Memory Offloading&quot;">​</a></h2><p>My next goal was to scale the mat-mult as far as I could using memory offloading; and maybe even simulate the first mat-mult operation of a small Phi model 😅</p><p>I intended on storing runtime memory on an SD card, so I can handle very large matrices. I found several possible approaches to this- There is the very impractical approach of writing directly at the block level, in 512 byte chunks, with something like the SDFat library. This appears to require a lot of attention to wear-leveling and block management.</p><p>The more feasible approach is to work with a file system abstraction- simply creating and appending to .txt files.</p><p>To set this up I extracted the first attention head weights (768 , 768 each) from the GPT2 model. I also created an embedded+normalized token sequence (7 , 768). I saved each of these matrices to a binary file. <img src="'+k+'" alt=""></p><p>My next goal was to successfully calculate the Q, K, and V matrices with memory offloading/ without overflowing the ATmega&#39;s memory.</p><p>My initial approach for memory offloading was as follow:</p><ul><li>Open weight and input files from the SD</li><li>Read and multiply element-wise</li><li>Store the intermediate multiplication values on the SD in a temp.bin file</li><li>Once all multiplication is complete, open the temp.bin file</li><li>Read and sum the row chunks, for final mat-mul result</li><li>Store resulting matrix in an output.bin file For my 7 token sequence, this would take about 4,128,768 multiplication and write operations, then another 4,128,768 read, addition, and final output write operations; just for the Q matrix!</li></ul><p>I will probably eventually need to implement some type of chunking scheme to reduce the read/write ops</p><p>Aside: I had hoped to implement the SD card communication from scratch like I did with the UART communication, but it appears to be a bit more complicated. Bringing in the arduino SD library would be simpler, but it is leading to a web of other arduino dependencies which I really do not want to bring into this project. The SD library provides very helpful methods like seek(), so I think it will be indispensable to this project, I just need to get it compiled with avr-gcc/ working outside of the arduino IDE ecosystem</p><p>Aside 2: Interesting note, the SD card library provides these convenient methods- seek(), read(), and write()- that appear to operate on linear chunks of memory, but actually operate through a &quot;Flash Translation Layer&quot; on the SD card. This abstraction layer translates logical memory addresses to random physical locations on the flash memory, spreading out writes across the card, preventing any one area from wearing out prematurely</p><p>It turns out, using the arduino SD card library outside of the arduino ecosystem is impractical, there are just too many extraneous dependencies. So I had to resort to using the arduino-cli instead of avr-gcc But I successfully setup the SD card and got basic multiplication working. Now to load in some large matrices</p><h3 id="a-note-on-quantization" tabindex="-1">A note on quantization <a class="header-anchor" href="#a-note-on-quantization" aria-label="Permalink to &quot;A note on quantization&quot;">​</a></h3><blockquote><p>Typically only the weights that participate in matmuls are quantized. All the other parameters (e.g. especially the scale and bias in RMSNorm) are kept in float32, because these layers are very sensitive. Here, we go one step further and additionally quantize the activations in the forward pass. This requires us to dynamically quantize and dequantize between float32 and int8 at runtime, which adds overhead. But the benefit is that now the majority of the calculations are using pure integer arithmetic. <a href="https://github.com/karpathy/llama2.c?tab=readme-ov-file#int8-quantization" target="_blank" rel="noreferrer">Karpathy, discussing llama2.c</a></p></blockquote><p>The ATmega does not have dedicated Floating Point math hardware but can do floating point math through software, which can take several hundred clock cycles to complete a simple operation.</p><p>While matrix multiplication can be broken down into piece-wise operations, there are ops where an entire row or matrix needs to be in memory, like softmax.<img src="'+l+'" alt=""></p><h2 id="closing-thoughts" tabindex="-1">Closing Thoughts <a class="header-anchor" href="#closing-thoughts" aria-label="Permalink to &quot;Closing Thoughts&quot;">​</a></h2><p>My main goal in this project was to better understand the minimum requirements necessary to run state-of-the-art language models.</p><p>The biggest insight I gained is that <ins>memory is the only constraint</ins>. GPU&#39;s perform calculation much faster, but they are not strictly necessary.</p>',40),r=[e];function D(A,d,y,g,E,o){return a(),s("div",null,r)}const C=i(p,[["render",D]]);export{F as __pageData,C as default};
