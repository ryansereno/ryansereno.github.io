<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Running an LLM on a $2 Microcontroller | Ryan Sereno</title>
    <meta name="description" content="Memory is all you need!">
    <meta name="generator" content="VitePress v1.1.4">
    <link rel="preload stylesheet" href="/assets/style.B_vpzdav.css" as="style">
    
    <script type="module" src="/assets/app.kh57VrW3.js"></script>
    <link rel="modulepreload" href="/assets/chunks/framework.D4geoam_.js">
    <link rel="modulepreload" href="/assets/chunks/theme.BRBLe-hA.js">
    <link rel="modulepreload" href="/assets/micro-llm.md.Cw5iuyrb.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
    <link rel="preload" href="/assets/ClassicXtraRound-Medium.D2jB9frL.ttf" as="font" type="font/ttf" crossorigin="anonymous">
    <meta property="og:title" content="Running an LLM on a $2 Microcontroller">
    <meta property="og:type" content="article">
    <meta property="og:image" content="undefined">
    <meta property="og:url" content="https://ryansereno.com/micro-llm">
    <meta property="og:description" content="Memory is all you need!">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@ry_serene">
    <meta name="twitter:title" content="Running an LLM on a $2 Microcontroller">
    <meta name="twitter:description" content="Memory is all you need!">
    <meta name="twitter:image" content="undefined">
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-5d98c3a5><!--[--><!--]--><!--[--><span tabindex="-1" data-v-0f60ec36></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-0f60ec36> Skip to content </a><!--]--><!----><header class="VPNav" data-v-5d98c3a5 data-v-ae24b3ad><div class="VPNavBar top" data-v-ae24b3ad data-v-ccf7ddec><div class="wrapper" data-v-ccf7ddec><div class="container" data-v-ccf7ddec><div class="title" data-v-ccf7ddec><div class="VPNavBarTitle" data-v-ccf7ddec data-v-ab179fa1><a class="title" href="/" data-v-ab179fa1><!--[--><!--]--><!----><span data-v-ab179fa1>Ryan Sereno</span><!--[--><!--]--></a></div></div><div class="content" data-v-ccf7ddec><div class="content-body" data-v-ccf7ddec><!--[--><!--]--><div class="VPNavBarSearch search" data-v-ccf7ddec><!----></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-ccf7ddec data-v-7f418b0f><span id="main-nav-aria-label" class="visually-hidden" data-v-7f418b0f>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/about.html" tabindex="0" data-v-7f418b0f data-v-9c663999><!--[--><span data-v-9c663999>About</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-ccf7ddec data-v-e6aabb21><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-e6aabb21 data-v-d1f28634 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-d1f28634></span><span class="vpi-moon moon" data-v-d1f28634></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-ccf7ddec data-v-0394ad82 data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://github.com/ryansereno" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-eee4e7cb><span class="vpi-social-github" /></a><a class="VPSocialLink no-icon" href="https://twitter.com/ry_serene" aria-label="Ryan&#39;s Twitter" target="_blank" rel="noopener" data-v-7bc22406 data-v-eee4e7cb><svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="48" height="48" viewBox="5 4 40 40"> <path fill="#03A9F4" d="M42,12.429c-1.323,0.586-2.746,0.977-4.247,1.162c1.526-0.906,2.7-2.351,3.251-4.058c-1.428,0.837-3.01,1.452-4.693,1.776C34.967,9.884,33.05,9,30.926,9c-4.08,0-7.387,3.278-7.387,7.32c0,0.572,0.067,1.129,0.193,1.67c-6.138-0.308-11.582-3.226-15.224-7.654c-0.64,1.082-1,2.349-1,3.686c0,2.541,1.301,4.778,3.285,6.096c-1.211-0.037-2.351-0.374-3.349-0.914c0,0.022,0,0.055,0,0.086c0,3.551,2.547,6.508,5.923,7.181c-0.617,0.169-1.269,0.263-1.941,0.263c-0.477,0-0.942-0.054-1.392-0.135c0.94,2.902,3.667,5.023,6.898,5.086c-2.528,1.96-5.712,3.134-9.174,3.134c-0.598,0-1.183-0.034-1.761-0.104C9.268,36.786,13.152,38,17.321,38c13.585,0,21.017-11.156,21.017-20.834c0-0.317-0.01-0.633-0.025-0.945C39.763,15.197,41.013,13.905,42,12.429"></path></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-ccf7ddec data-v-d0bd9dde data-v-b6c34ac9><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-b6c34ac9><span class="vpi-more-horizontal icon" data-v-b6c34ac9></span></button><div class="menu" data-v-b6c34ac9><div class="VPMenu" data-v-b6c34ac9 data-v-e7ea1737><!----><!--[--><!--[--><!----><div class="group" data-v-d0bd9dde><div class="item appearance" data-v-d0bd9dde><p class="label" data-v-d0bd9dde>Appearance</p><div class="appearance-action" data-v-d0bd9dde><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-d0bd9dde data-v-d1f28634 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-d1f28634></span><span class="vpi-moon moon" data-v-d1f28634></span><!--]--></span></span></button></div></div></div><div class="group" data-v-d0bd9dde><div class="item social-links" data-v-d0bd9dde><div class="VPSocialLinks social-links-list" data-v-d0bd9dde data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://github.com/ryansereno" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-eee4e7cb><span class="vpi-social-github" /></a><a class="VPSocialLink no-icon" href="https://twitter.com/ry_serene" aria-label="Ryan&#39;s Twitter" target="_blank" rel="noopener" data-v-7bc22406 data-v-eee4e7cb><svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="48" height="48" viewBox="5 4 40 40"> <path fill="#03A9F4" d="M42,12.429c-1.323,0.586-2.746,0.977-4.247,1.162c1.526-0.906,2.7-2.351,3.251-4.058c-1.428,0.837-3.01,1.452-4.693,1.776C34.967,9.884,33.05,9,30.926,9c-4.08,0-7.387,3.278-7.387,7.32c0,0.572,0.067,1.129,0.193,1.67c-6.138-0.308-11.582-3.226-15.224-7.654c-0.64,1.082-1,2.349-1,3.686c0,2.541,1.301,4.778,3.285,6.096c-1.211-0.037-2.351-0.374-3.349-0.914c0,0.022,0,0.055,0,0.086c0,3.551,2.547,6.508,5.923,7.181c-0.617,0.169-1.269,0.263-1.941,0.263c-0.477,0-0.942-0.054-1.392-0.135c0.94,2.902,3.667,5.023,6.898,5.086c-2.528,1.96-5.712,3.134-9.174,3.134c-0.598,0-1.183-0.034-1.761-0.104C9.268,36.786,13.152,38,17.321,38c13.585,0,21.017-11.156,21.017-20.834c0-0.317-0.01-0.633-0.025-0.945C39.763,15.197,41.013,13.905,42,12.429"></path></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-ccf7ddec data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><div class="divider" data-v-ccf7ddec><div class="divider-line" data-v-ccf7ddec></div></div></div><!----></header><div class="VPLocalNav empty fixed" data-v-5d98c3a5 data-v-a6f0e41e><div class="container" data-v-a6f0e41e><!----><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-a6f0e41e data-v-17a5e62e><button data-v-17a5e62e>Return to top</button><!----></div></div></div><!----><div class="VPContent" id="VPContent" data-v-5d98c3a5 data-v-1428d186><div class="VPDoc has-aside" data-v-1428d186 data-v-39a288b8><!--[--><!--]--><div class="container" data-v-39a288b8><div class="aside" data-v-39a288b8><div class="aside-curtain" data-v-39a288b8></div><div class="aside-container" data-v-39a288b8><div class="aside-content" data-v-39a288b8><div class="VPDocAside" data-v-39a288b8 data-v-3f215769><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" role="navigation" data-v-3f215769 data-v-269c27a6><div class="content" data-v-269c27a6><div class="outline-marker" data-v-269c27a6></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-269c27a6>On this page</div><ul class="VPDocOutlineItem root" data-v-269c27a6 data-v-b933a997><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-39a288b8><div class="content-container" data-v-39a288b8><!--[--><!--]--><main class="main" data-v-39a288b8><div style="position:relative;" class="vp-doc _micro-llm" data-v-39a288b8><div><h1 id="running-an-llm-on-a-2-microcontroller" tabindex="-1">Running an LLM on a $2 Microcontroller <a class="header-anchor" href="#running-an-llm-on-a-2-microcontroller" aria-label="Permalink to &quot;Running an LLM on a $2 Microcontroller&quot;">​</a></h1><p><em>Memory is all you need!</em></p><hr><p>I took a weekend and tried to get an LLM running on an 8bit microcontroller- the ATmega328p in particular.</p><p>This was of course an exercise in futility that turned into a simpler ambition of getting the self-attention math working on the chip.</p><p>It ballooned into several weeks of researching matrix multiplication kernels, quantization, and solid state memory.</p><p>I wanted to take this as far as possible so I could understand, at a fundamental level, what minimum resources are required to run one of these models.</p><blockquote><p>“What I cannot build, I do not understand” -Feynman</p></blockquote><p><img src="/assets/atmega-llm.BiQfn5A3.png" alt=""></p><div class="info custom-block"><p class="custom-block-title">Overview</p><p>What:</p><ul><li>Running modern LLM&#39;s, even the smallest ones, requires a generous amount of memory, typically on the order of 10&#39;s or 100&#39;s of GB&#39;s</li><li>The ATmega328P is a $2 chip, with 2KB of memory (0.00000025 GB)</li><li>The Atmega has none of the parallelism or multi-threading that modern GPU&#39;s and CPU&#39;s have, but it is capable of performing basic integer math</li><li>Roughly analogous to how RAM works in GPU&#39;s and CPU&#39;s, I was able to expand the working memory of the ATmega with an SD card</li><li>Getting an entire LLM running on this chip is infeasible (it would take hours to produce a single token), but I did succeed in implementing Self-Attention calculations on the chip</li></ul><p>Why:</p><ul><li>AI will become prolific and embedded in many edge devices</li><li>Many applications are power constrained or do not require a full-fledged operating system to perform tasks</li><li>Implementing an LLM on such a resource constrained board helped me understand the minimum requirements needed for real-world embedded applications</li></ul></div><h2 id="part-1-setting-up-a-math-validation-tool" tabindex="-1">Part 1: Setting up a math validation tool <a class="header-anchor" href="#part-1-setting-up-a-math-validation-tool" aria-label="Permalink to &quot;Part 1: Setting up a math validation tool&quot;">​</a></h2><p>I wanted to start simple to see what math I could feasibly do on the chip; that meant multiplying just two numbers.</p><p>The easiest way to do this was to input numbers to a computer, send to the chip for calculation, get the result back, and validate it the result.</p><p>I did this through a basic python client, and serial communication.</p><details class="details custom-block"><summary>Python client:</summary><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes catppuccin-macchiato night-owl vp-code"><code><span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">import</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> serial</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">import</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> time</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">def</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> send_numbers</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">(</span><span style="--shiki-light:#EE99A0;--shiki-dark:#7FDBCA;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">,</span><span style="--shiki-light:#EE99A0;--shiki-dark:#7FDBCA;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> a</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">,</span><span style="--shiki-light:#EE99A0;--shiki-dark:#7FDBCA;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> b</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">:</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">    ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">write</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">bytes</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">[</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">a </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">+</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 128</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> b </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">+</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 128</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">]</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">def</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> receive_result</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">(</span><span style="--shiki-light:#EE99A0;--shiki-dark:#7FDBCA;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">:</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    return</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> int</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">readline</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">()</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">decode</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">()</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">strip</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">())</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">ser </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> serial</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">Serial</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">/dev/tty.usbmodem2101</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 9600</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D7DBE0;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> timeout</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;">1</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">time</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">sleep</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;">2</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Connected to Arduino. Ready...</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">while</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#FF5874;"> True</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">:</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    try</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">:</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">        a </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> int</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">input</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Enter first number (-128 to 127): </span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">        b </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> int</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">input</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Enter second number (-128 to 127): </span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">        print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#C792EA;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">f</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">&quot;</span><span style="--shiki-light:#F5BDE6;--shiki-dark:#F78C6C;">\n</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Multiplying </span><span style="--shiki-light:#F5BDE6;--shiki-dark:#82AAFF;">{</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">a</span><span style="--shiki-light:#F5BDE6;--shiki-dark:#82AAFF;">}</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;"> and </span><span style="--shiki-light:#F5BDE6;--shiki-dark:#82AAFF;">{</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">b</span><span style="--shiki-light:#F5BDE6;--shiki-dark:#82AAFF;">}</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">        send_numbers</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> a</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> b</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">        arduino_result </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;"> receive_result</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">        expected_result </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> a </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">*</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> b</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">        print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#C792EA;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">f</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">&quot;Arduino result: </span><span style="--shiki-light:#F5BDE6;--shiki-dark:#82AAFF;">{</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">arduino_result</span><span style="--shiki-light:#F5BDE6;--shiki-dark:#82AAFF;">}</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">        print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#C792EA;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">f</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">&quot;Expected result: </span><span style="--shiki-light:#F5BDE6;--shiki-dark:#82AAFF;">{</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">expected_result</span><span style="--shiki-light:#F5BDE6;--shiki-dark:#82AAFF;">}</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">        if</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> arduino_result </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">==</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> expected_result</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">:</span></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">            print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Result passed.</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">        else</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">:</span></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">            print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Result failed.</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">close</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">()</span></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Connection closed.</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span></code></pre></div></details><p>ATmega program:</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes catppuccin-macchiato night-owl vp-code"><code><span class="line"><span style="--shiki-light:#EED49F;--shiki-dark:#C792EA;">#</span><span style="--shiki-light:#EED49F;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">include</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;"> &lt;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">stdint.h</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#EED49F;--shiki-dark:#C792EA;">#</span><span style="--shiki-light:#EED49F;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">define</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> BAUD</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 9600</span></span>
<span class="line"><span style="--shiki-light:#EED49F;--shiki-dark:#C792EA;">#</span><span style="--shiki-light:#EED49F;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">define</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> F_CPU</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 16000000</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#FFEB95;">UL</span></span>
<span class="line"><span style="--shiki-light:#EED49F;--shiki-dark:#C792EA;">#</span><span style="--shiki-light:#EED49F;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">define</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> UBRR_VALUE</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> ((</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">F_CPU </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;">/</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">BAUD </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;">*</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 16</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#FFEB95;">UL</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">))</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;"> -</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 1</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6E738D;--shiki-dark:#637777;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">//</span><span style="--shiki-light:#6E738D;--shiki-dark:#637777;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">serial communication setup</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">void</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> uart_init</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">()</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> {</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">  UBRR0H </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">uint8_t</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">UBRR_VALUE </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">&gt;&gt;</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 8</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">);</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">  UBRR0L </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">uint8_t</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">UBRR_VALUE</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">  UCSR0B </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;">1</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;"> &lt;&lt;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> RXEN0</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;"> |</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;">1</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;"> &lt;&lt;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> TXEN0</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">);</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">  UCSR0C </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;">3</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;"> &lt;&lt;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> UCSZ00</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">);</span></span>
<span class="line"><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">void</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> uart_transmit</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">uint8_t</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D7DBE0;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> data</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> {</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  while</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">!</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">UCSR0A </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;">&amp;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;">1</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;"> &lt;&lt;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> UDRE0</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)))</span></span>
<span class="line"><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">    ;</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">  UDR0 </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> data</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span></span>
<span class="line"><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">uint8_t</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> uart_receive</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">()</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> {</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  while</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">!</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">UCSR0A </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;">&amp;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;">1</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;"> &lt;&lt;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> RXC0</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)))</span></span>
<span class="line"><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">    ;</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  return</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> UDR0</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span></span>
<span class="line"><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">void</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> uart_print_number</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">int16_t</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D7DBE0;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> num</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> {</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">  char</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#C5E478;"> buffer</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">[</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;">7</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">];</span></span>
<span class="line"><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  itoa</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">num</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> buffer</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 10</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  for</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">char</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;"> *</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">p </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> buffer</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;"> *</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">p</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> p</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">++</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> {</span></span>
<span class="line"><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    uart_transmit</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">(</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;">*</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">p</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span></span>
<span class="line"><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">  }</span></span>
<span class="line"><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  uart_transmit</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&#39;</span><span style="--shiki-light:#F5BDE6;--shiki-dark:#F78C6C;">\n</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&#39;</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> </span></span>
<span class="line"><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">int</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> main</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">void</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> {</span></span>
<span class="line"><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  uart_init</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">()</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  while</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;">1</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> {</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">    int8_t</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> A </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">int8_t</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">uart_receive</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">()</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;"> -</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 128</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">    int8_t</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> B </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">int8_t</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">uart_receive</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">()</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;"> -</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 128</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">    int16_t</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> C </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">int16_t</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">A </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;">*</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> B</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    uart_print_number</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">C</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span></span>
<span class="line"><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  return</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 0</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span></span>
<span class="line"><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">}</span></span></code></pre></div><p>I setup everything under the assumption that I would eventually be using an 8bit quantized model.</p><p>This enables me to work primarily with signed integers (ranging from -128 to 127), instead of floating point numbers.</p><p>I used the int8 data type and shifted values to be between -128 and 127.</p><p>Two-number multiplication results can overflow into the 16bit range.</p><p><img src="/assets/simple-multiply.Bjy3ktAa.png" alt="simple-multiply.png"> Once this was working, and the validation tests were passing, I felt comfortable expanding this to matrix multiplication.</p><h2 id="part-2-matrix-multiplication" tabindex="-1">Part 2: Matrix Multiplication <a class="header-anchor" href="#part-2-matrix-multiplication" aria-label="Permalink to &quot;Part 2: Matrix Multiplication&quot;">​</a></h2><p>If I could multiply two numbers, I felt it would be pretty straightforward to extend it to a matrix.</p><p>I started with 2D matrices.</p><p>For the sake of simplicity, I flattened 2D matrices into 1D arrays.</p><p>This enabled memory to be easily allocated and accessed in contiguous blocks.</p><p>Indexing into a value can be done with: <code>matrix[i * size + k]</code> Where <code>i</code> is the row index, <code>size</code> is the column dimension, and <code>k</code> is the column index</p><p>For the matrix multiplication &quot;kernel&#39;&quot;, I used a brute force loop approach, borrowed from <a href="https://forum.arduino.cc/t/arduino-matrix-math-library/38123" target="_blank" rel="noreferrer">here</a>.</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes catppuccin-macchiato night-owl vp-code"><code><span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">void</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> matmult</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">int8_t</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;"> *</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D7DBE0;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">A</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">,</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;"> int8_t</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;"> *</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D7DBE0;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">B</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">,</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;"> int16_t</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;"> *</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D7DBE0;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">C</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">,</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;"> uint8_t</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D7DBE0;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> rows_A</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">,</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">                     uint8_t</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D7DBE0;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> cols_A</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">,</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;"> uint8_t</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D7DBE0;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> cols_B</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> {</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  for</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">uint8_t</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> i </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 0</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> i </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">&lt;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> rows_A</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> i</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">++</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> {</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    for</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">uint8_t</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> j </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 0</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> j </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">&lt;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> cols_B</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> j</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">++</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> {</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">      int32_t</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> sum </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 0</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">      for</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">uint8_t</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> k </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 0</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> k </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">&lt;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> cols_A</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> k</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">++</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> {</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">        sum </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">+=</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">int32_t</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#C5E478;">A</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">[</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">i </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;">*</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> cols_A </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;">+</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> k</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">]</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;"> *</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#C5E478;"> B</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">[</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">k </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;">*</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> cols_B </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;">+</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> j</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">];</span></span>
<span class="line"><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">      }</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#C5E478;">      C</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">[</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">i </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;">*</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> cols_B </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;">+</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> j</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">]</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;"> =</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">int16_t</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">sum</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span></span>
<span class="line"><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">    }</span></span>
<span class="line"><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">  }</span></span>
<span class="line"><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">}</span></span></code></pre></div><p>Because the values are stored inside of 1D arrays the dimensions of the matrices need to be explicitly passed in.</p><p>I generated matrices with numpy, and used <code>np.array_equal()</code> to validate the results returned by the chip.</p><details class="details custom-block"><summary>Python client:</summary><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes catppuccin-macchiato night-owl vp-code"><code><span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">import</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> time</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">import</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> numpy </span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">as</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> np</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">import</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> serial</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">def</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> send_matrix</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">(</span><span style="--shiki-light:#EE99A0;--shiki-dark:#7FDBCA;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">,</span><span style="--shiki-light:#EE99A0;--shiki-dark:#7FDBCA;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> matrix</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">:</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    for</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> value </span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">in</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> matrix</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">flatten</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">():</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">        ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">write</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">bytes</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">[</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">value </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">+</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 128</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">]</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">))</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">def</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> receive_matrix</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">(</span><span style="--shiki-light:#EE99A0;--shiki-dark:#7FDBCA;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">,</span><span style="--shiki-light:#EE99A0;--shiki-dark:#7FDBCA;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> rows</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">,</span><span style="--shiki-light:#EE99A0;--shiki-dark:#7FDBCA;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> cols</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">:</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">    matrix </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> np</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">zeros</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">rows</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> cols</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D7DBE0;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> dtype</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">np</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">.</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">int16</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    for</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> i </span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">in</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> range</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">rows</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">):</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">        for</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> j </span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">in</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> range</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">cols</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">):</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">            value_str </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">readline</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">().</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">decode</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">().</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">strip</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">()</span></span>
<span class="line"><span style="--shiki-light:#EE99A0;--shiki-dark:#D6DEEB;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">            matrix</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">[</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D6DEEB;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">i</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">,</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D6DEEB;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> j</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">]</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;"> =</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> int</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">value_str</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    return</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> matrix</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">ser </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> serial</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">Serial</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">/dev/tty.usbmodem2101</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 9600</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D7DBE0;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> timeout</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;">5</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">time</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">sleep</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;">2</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Connected...</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">while</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#FF5874;"> True</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">:</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">    rows_A </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> int</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">input</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">A matrix rows (1-16, or 0 to quit): </span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">))</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">    cols_A </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> int</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">input</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">A matrix columns (1-16): </span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">))</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">    cols_B </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> int</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">input</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">B matrix columns (1-16): </span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">    A </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> np</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">random</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">randint</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">-</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;">128</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 127</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;"> (</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">rows_A</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> cols_A</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D7DBE0;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> dtype</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">np</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">.</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">int8</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">    B </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> np</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">random</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">randint</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">-</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;">128</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 127</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;"> (</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">cols_A</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> cols_B</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D7DBE0;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> dtype</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">np</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">.</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">int8</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">    print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Matrix A:</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">    print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">A</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">    print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Matrix B:</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">    print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">B</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6E738D;--shiki-dark:#637777;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">    #</span><span style="--shiki-light:#6E738D;--shiki-dark:#637777;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> Send size and matrices</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">    ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">write</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">bytes</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">[</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">rows_A</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">]</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">))</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">    ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">write</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">bytes</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">[</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">cols_A</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">]</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">))</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">    ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">write</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">bytes</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">[</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">cols_B</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">]</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">))</span></span>
<span class="line"><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">    send_matrix</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> A</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">    send_matrix</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> B</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">    C </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;"> receive_matrix</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> rows_A</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> cols_B</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">    print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Result Matrix C:</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">    print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">C</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">    expected </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> np</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">matmul</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">A</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">astype</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">np</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">.</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">int32</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> B</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">astype</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">np</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">.</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">int32</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)).</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">astype</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">np</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">.</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">int16</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">    print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#C792EA;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">f</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">&quot;Expected Matrix C: </span><span style="--shiki-light:#F5BDE6;--shiki-dark:#82AAFF;">{</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">expected</span><span style="--shiki-light:#F5BDE6;--shiki-dark:#82AAFF;">}</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    if</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> np</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">array_equal</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">C</span><span style="--shiki-light:#939AB7;--shiki-dark:#D9F5DD;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> expected</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">):</span></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">        print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Result passed.</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    else</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">:</span></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">        print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Result failed</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">        print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Expected:</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">        print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">expected</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">        print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Difference:</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">        print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">C </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">-</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> expected</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">ser</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#B2CCD6;">close</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">()</span></span>
<span class="line"><span style="--shiki-light:#F5A97F;--shiki-dark:#C5E478;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">print</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Connection closed.</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span></span></code></pre></div></details><p>It took several hours of debugging to get this working; the math was wrong every time.</p><p>I really handicapped myself by writing my serial communication from scratch;</p><p>It was difficult figuring out if my problems were math, memory management or data transfer related (turns out it was the latter..)</p><p>After several iterations of rewriting my code and referring back to my basic multiplication example, I finally got my tests to pass on square matrices, and then finally matrices of varying dimensions.</p><p><img src="/assets/matrix-multiply.BzfPaAF2.png" alt=""> This is where I ran into my first concrete roadblock; the one that I understood most easily from the beginning: The atmega328p has 2kB of RAM/ volatile memory.</p><p>This means it can hold a theoretical maximum of 2048 int8 values, or just one 45x45 int8 matrix.</p><p>Mat-Mult requires allocation for 3 matrices, the third being int16 or int32 (because mat-mult of large int8 matrices could result in numbers higher than 32,768), so the maximum allowable dimension for each matrix is quite small.</p><p>My goal from the beginning was never to run this <em>entirely</em> on the ATmega, but to offload memory onto pseudo ram, ie repurposed solid state storage like an SD card.</p><p>In my naive outlook, there isn&#39;t anything <em>fundamentally</em> different about volatile memory and solid state memory, they&#39;re both just storing bits somewhere 🤷</p><p>Sure there are many differences in speed and how data is accessed, but I felt I could at least implement a toy example for my own curiosity.</p><h2 id="part-3-memory-offloading" tabindex="-1">Part 3: Memory Offloading <a class="header-anchor" href="#part-3-memory-offloading" aria-label="Permalink to &quot;Part 3: Memory Offloading&quot;">​</a></h2><p>My next goal was to scale the mat-mult as far as I could using memory offloading; and then simulate the first mat-mult operation of a small Llama model.</p><p>I intended to store runtime memory on an SD card, so I could handle very large matrices.</p><p><img src="/assets/Signal%20Note%20to%20Self%20-%202024-09-05%2008_15_12.Dko9Mq5f.jpeg" alt=""></p><p>I found several possible approaches to this- There is the very impractical approach of writing directly at the block level, in 512 byte chunks, with something like the SDFat library.</p><p>This appears to require a lot of attention to wear-leveling and block management.</p><p>The more feasible approach is to work with a file system abstraction- simply creating and appending to .txt or .bin files.</p><p>I had hoped to implement the SD card communication from scratch like I did with the UART communication, but it appeared to be more complicated than I expected.</p><p>The SD library provides very helpful methods like seek(), so I it was indispensable to this project.</p><p>It turns out, using the arduino SD card library outside of the arduino ecosystem is impractical, there are just too many extraneous dependencies.</p><p>So I had to resort to using the arduino-cli instead of avr-gcc</p><p>To set up the matrix multiplication, I extracted the first attention head weights (768 , 768 each) from the GPT2 model.</p><p>I also created an embedded+normalized token sequence (7 , 768).</p><p>I saved each of these matrices to a binary file.</p><p><img src="/assets/Screenshot%202024-09-08%20at%201.16.39%20PM.DNhkExB2.png" alt=""></p><p>My next goal was to successfully calculate the Q, K, and V matrices with memory offloading/ without overflowing the ATmega&#39;s memory.</p><p>My initial approach for memory offloading was as follow:</p><ul><li>Open weight and input files from the SD</li><li>Read and multiply element-wise</li><li>Store the intermediate multiplication values on the SD in a temp.bin file</li><li>Once all multiplication is complete, re-open the temp.bin file</li><li>Read and sum the row chunks, for final mat-mul result</li><li>Store resulting matrix in an output.bin file</li></ul><p>For my 7 token sequence, this would take about 4,128,768 multiplication and write operations, then another 4,128,768 read, addition, and final output write operations; just for the Q matrix!</p><p>I will probably eventually need to implement some type of chunking scheme to reduce the read/write ops.</p><p>After some more trial and error, and learning how the arduino SD card library works, I was finally getting correct mat-mul results for the Q matrix.</p><div class="info custom-block"><p class="custom-block-title">A note on solid state memory:</p><p>Interesting note, the SD card library provides convenient methods- seek(), read(), and write()- that appear to operate on linear chunks of memory, but actually operate through a &quot;Flash Translation Layer&quot; on the SD card.</p><p>This abstraction layer translates logical memory addresses to random physical locations on the flash memory, spreading out writes across the card, preventing any one area from wearing out prematurely</p></div><h2 id="part-4-calculating-q-k-v" tabindex="-1">Part 4: Calculating Q,K,V <a class="header-anchor" href="#part-4-calculating-q-k-v" aria-label="Permalink to &quot;Part 4: Calculating Q,K,V&quot;">​</a></h2><p>The full scheme looks like this:</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes catppuccin-macchiato night-owl vp-code"><code><span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">void</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> mat_mul</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">File </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;">&amp;</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D7DBE0;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">A</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> File </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;">&amp;</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D7DBE0;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">B</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> File </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;">&amp;</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D7DBE0;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">C</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">,</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;"> uint16_t</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D7DBE0;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> rows_A</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">,</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;"> uint16_t</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D7DBE0;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> cols_A</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">,</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;"> uint16_t</span><span style="--shiki-light:#EE99A0;--shiki-dark:#D7DBE0;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> cols_B</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> {</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">  int8_t</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> a_val</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> b_val</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">  int32_t</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> product</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">  File temp </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#C5E478;"> SD</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">open</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">temp.bin</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> FILE_WRITE</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">);</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">  </span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  for</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">uint16_t</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> i </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 0</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> i </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">&lt;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> rows_A</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> i</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">++</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> {</span><span style="--shiki-light:#6E738D;--shiki-dark:#637777;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> //</span><span style="--shiki-light:#6E738D;--shiki-dark:#637777;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> for every row of A</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    for</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">uint16_t</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> j </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 0</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> j </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">&lt;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> cols_B</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> j</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">++</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> {</span><span style="--shiki-light:#6E738D;--shiki-dark:#637777;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> //</span><span style="--shiki-light:#6E738D;--shiki-dark:#637777;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> for every column of B</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">      int32_t</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> sum </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 0</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">      for</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">uint16_t</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> k </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#F5A97F;--shiki-dark:#F78C6C;"> 0</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> k </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">&lt;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> cols_A</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> k</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">++</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> {</span><span style="--shiki-light:#6E738D;--shiki-dark:#637777;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;"> //</span><span style="--shiki-light:#6E738D;--shiki-dark:#637777;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">for every element in the column</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#C5E478;">        A</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">seek</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">i </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;">*</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> cols_A </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;">+</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> k</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">)</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;"> *</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;"> sizeof</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">(</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">int8_t</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">);</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#C5E478;">        B</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">seek</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">k </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;">*</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> cols_B </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;">+</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> j</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">)</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;"> *</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;"> sizeof</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">(</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">int8_t</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">);</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">        a_val </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#C5E478;"> A</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">read</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">();</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">        b_val </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#C5E478;"> B</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">read</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">();</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">        product </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> (</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">int32_t</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">)</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">a_val </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;">*</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> b_val</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">        sum </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">+=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;"> product</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span></span>
<span class="line"><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">      }</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#C5E478;">      temp</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">write</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">(</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">uint8_t</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;"> *</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">)</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;">&amp;</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">sum</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#8BD5CA;--shiki-dark:#7FDBCA;"> sizeof</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">(</span><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">int32_t</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">);</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#C5E478;">      temp</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">flush</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">();</span></span>
<span class="line"><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">    }</span></span>
<span class="line"><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">  }</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">  </span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#C5E478;">  temp</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">close</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">();</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">  </span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#C5E478;">  SD</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">remove</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">temp.bin</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">);</span></span>
<span class="line"><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C6A0F6;--shiki-dark:#C792EA;">void</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> q_k_v</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">()</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;"> {</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">  File Qw </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#C5E478;"> SD</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">open</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Qw.BIN</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> FILE_READ</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">);</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">  File Embed </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#C5E478;"> SD</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">open</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">EMBED.BIN</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> FILE_READ</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">);</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">  File Q </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#C5E478;"> SD</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">open</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Q.BIN</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> FILE_WRITE</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">);</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">  </span></span>
<span class="line"><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  mat_mul</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">Qw</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> Embed</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> Q</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> MATRIX_SIZE</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> MATRIX_SIZE</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> SEQUENCE_LENGTH</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">  </span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#C5E478;">  Qw</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">close</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">();</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#C5E478;">  Embed</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">close</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">();</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#C5E478;">  Q</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">close</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">  File Kw </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#C5E478;"> SD</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">open</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Kw.BIN</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> FILE_READ</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">);</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">  File Embed </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#C5E478;"> SD</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">open</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">EMBED.BIN</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> FILE_READ</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">);</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">  File K </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#C5E478;"> SD</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">open</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">K.BIN</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> FILE_WRITE</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">);</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">  </span></span>
<span class="line"><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  mat_mul</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">Kw</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> Embed</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> K</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> MATRIX_SIZE</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> MATRIX_SIZE</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> SEQUENCE_LENGTH</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">  </span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#C5E478;">  Kw</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">close</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">();</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#C5E478;">  Embed</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">close</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">();</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#C5E478;">  K</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">close</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">  File Vw </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#C5E478;"> SD</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">open</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">Vw.BIN</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> FILE_READ</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">);</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">  File Embed </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#C5E478;"> SD</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">open</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">EMBED.BIN</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> FILE_READ</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">);</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#D6DEEB;">  File V </span><span style="--shiki-light:#8BD5CA;--shiki-dark:#C792EA;">=</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#C5E478;"> SD</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">open</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">(</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#A6DA95;--shiki-dark:#ECC48D;">V.BIN</span><span style="--shiki-light:#A6DA95;--shiki-dark:#D9F5DD;">&quot;</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> FILE_WRITE</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  mat_mul</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">(</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;">Vw</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> Embed</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> V</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> MATRIX_SIZE</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> MATRIX_SIZE</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">,</span><span style="--shiki-light:#CAD3F5;--shiki-dark:#82AAFF;"> SEQUENCE_LENGTH</span><span style="--shiki-light:#939AB7;--shiki-dark:#82AAFF;">)</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#C5E478;">  Vw</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">close</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">();</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#C5E478;">  Embed</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">close</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">();</span></span>
<span class="line"><span style="--shiki-light:#CAD3F5;--shiki-dark:#C5E478;">  V</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">.</span><span style="--shiki-light:#8AADF4;--shiki-dark:#82AAFF;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">close</span><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">();</span></span>
<span class="line"><span style="--shiki-light:#939AB7;--shiki-dark:#D6DEEB;">}</span></span></code></pre></div><h3 id="a-note-on-quantization" tabindex="-1">A note on quantization <a class="header-anchor" href="#a-note-on-quantization" aria-label="Permalink to &quot;A note on quantization&quot;">​</a></h3><blockquote><p>Typically only the weights that participate in matmuls are quantized. All the other parameters (e.g. especially the scale and bias in RMSNorm) are kept in float32, because these layers are very sensitive. Here, we go one step further and additionally quantize the activations in the forward pass. This requires us to dynamically quantize and dequantize between float32 and int8 at runtime, which adds overhead. But the benefit is that now the majority of the calculations are using pure integer arithmetic.</p><p><a href="https://github.com/karpathy/llama2.c?tab=readme-ov-file#int8-quantization" target="_blank" rel="noreferrer">Karpathy, discussing llama2.c</a></p></blockquote><p>The ATmega does not have dedicated Floating Point math hardware but can do floating point math through software, which can take several hundred clock cycles to complete a simple operation.</p><p>While matrix multiplication can be broken down into piece-wise operations, there are ops where an entire row or matrix needs to be in memory, like softmax.</p><h2 id="closing-thoughts" tabindex="-1">Closing Thoughts <a class="header-anchor" href="#closing-thoughts" aria-label="Permalink to &quot;Closing Thoughts&quot;">​</a></h2><p>Out of curiosity, I wanted to see how large a full LLM instruction set would be.</p><p>I compiled <a href="https://github.com/karpathy/llama2.c" target="_blank" rel="noreferrer">llama2.c</a>, a very minimal implementation of llama2 written in pure C, by Andrej Karpathy.</p><p>The compiled program binary is 57KB in size.</p><p>This exceeds the 35KB of program flash memory that the ATmega has.</p><p>Also 57KB is the bare minimum binary size; it doesn&#39;t account for all of the special SD memory offloading instructions that would be necessary.</p><p>So running a full LLM on the ATmega is not possible, simply from an instruction-set standpoint.</p><p>That being said, this <em>could</em> be attainable with a more powerful board, like an STM32.</p><hr><p>My main goal in this project was to better understand the minimum requirements necessary to run state-of-the-art language models.</p><p>The biggest insight I gained is that <ins>memory, both flash and volatile, is the only real constraint</ins>.</p><p>GPU&#39;s perform calculation much faster, but they are not strictly necessary.</p><p>This being said, if the full model were to be implemented using this method, it would take many hours to complete one inference cycle, ie producing a single token.</p></div></div></main><footer class="VPDocFooter" data-v-39a288b8 data-v-d4a0bba5><!--[--><!--]--><!----><!----></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"my-curated-vim-command-collection.md\":\"BYcH4Yd_\",\"api-examples.md\":\"CVWG3xow\",\"index.md\":\"CxBZknOA\",\"the-encyclopedias.md\":\"l0PRiPEY\",\"religion-is-an-abstraction.md\":\"BYth-9s6\",\"reclaim-your-media.md\":\"CNPLvIvG\",\"pytorch.md\":\"CT646Tmt\",\"rnn.md\":\"fxbu20uN\",\"university.md\":\"Cg98uLAa\",\"intellectual-property.md\":\"ls2CA5gZ\",\"autonomous-computer.md\":\"Dyf_N12O\",\"the-orchard.md\":\"CWFLR0D5\",\"political-optimization.md\":\"BKhJ61V6\",\"crystallization.md\":\"BES0hRG3\",\"about.md\":\"DyRA6Ho9\",\"vue-event-bus.md\":\"Mzcad5iW\",\"art.md\":\"BvjHbcQ1\",\"cellular-automata.md\":\"D2NVDhTk\",\"nvim-dap.md\":\"DMfnstLL\",\"universal-function-approximators.md\":\"DVoidVYn\",\"self-attention.md\":\"CMBqWdYV\",\"micro-llm.md\":\"Cw5iuyrb\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"Ryan Sereno\",\"description\":\"I write about Software, Art, Poetry, and Frugality\",\"base\":\"/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"nav\":[{\"text\":\"About\",\"link\":\"/about\"}],\"sidebar\":[],\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/ryansereno\"},{\"icon\":{\"svg\":\"<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" x=\\\"0px\\\" y=\\\"0px\\\" width=\\\"48\\\" height=\\\"48\\\" viewBox=\\\"5 4 40 40\\\"> <path fill=\\\"#03A9F4\\\" d=\\\"M42,12.429c-1.323,0.586-2.746,0.977-4.247,1.162c1.526-0.906,2.7-2.351,3.251-4.058c-1.428,0.837-3.01,1.452-4.693,1.776C34.967,9.884,33.05,9,30.926,9c-4.08,0-7.387,3.278-7.387,7.32c0,0.572,0.067,1.129,0.193,1.67c-6.138-0.308-11.582-3.226-15.224-7.654c-0.64,1.082-1,2.349-1,3.686c0,2.541,1.301,4.778,3.285,6.096c-1.211-0.037-2.351-0.374-3.349-0.914c0,0.022,0,0.055,0,0.086c0,3.551,2.547,6.508,5.923,7.181c-0.617,0.169-1.269,0.263-1.941,0.263c-0.477,0-0.942-0.054-1.392-0.135c0.94,2.902,3.667,5.023,6.898,5.086c-2.528,1.96-5.712,3.134-9.174,3.134c-0.598,0-1.183-0.034-1.761-0.104C9.268,36.786,13.152,38,17.321,38c13.585,0,21.017-11.156,21.017-20.834c0-0.317-0.01-0.633-0.025-0.945C39.763,15.197,41.013,13.905,42,12.429\\\"></path></svg>\"},\"link\":\"https://twitter.com/ry_serene\",\"ariaLabel\":\"Ryan's Twitter\"}],\"aside\":false},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false}");</script>
    
  </body>
</html>